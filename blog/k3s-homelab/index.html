<!doctype html><html lang=en><head><meta charset=utf-8><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content="light dark" name=color-scheme><title>Kubernetes Homelab | The Oops Guy</title><meta content="Kubernetes Homelab" property=og:title><meta content="Pawan Chhetri" name=author><meta content=en-US property=og:locale><meta content="k3s on homelab" name=description><meta content="k3s on homelab" property=og:description><link href=https://pawanchhetri.com.np/blog/k3s-homelab/ rel=canonical><meta content=https://pawanchhetri.com.np/blog/k3s-homelab/ property=og:url><meta content="The Oops Guy" property=og:site_name><meta content=article property=og:type><meta content=2024-06-20T00:00:00+00:00 property=article:published_time><meta content=summary name=twitter:card><meta content="Kubernetes Homelab" property=twitter:title><meta content="k3s on homelab" name=description><title>Kubernetes Homelab</title><link href=/img/favicon-32x32.png rel=icon sizes=32x32 type=image/png><link href=/img/favicon-16x16.png rel=icon sizes=16x16 type=image/png><link href=/img/apple-touch-icon.png rel=apple-touch-icon sizes=180x180><style>body{--primary-color:#376dd9;--primary-pale-color:#698bcf1c;--inline-code-color:#444;--text-color:#444;--text-pale-color:#545967;--bg-color:#fff;--highlight-mark-color:#5f75b045;--callout-note-color:#3e70d6;--callout-important-color:#7a46cd;--callout-warning-color:#d3822b;--callout-alert-color:#d43f3f;--callout-question-color:#3089b5;--callout-tip-color:#35a06b;--main-font:"IBMPlexSans",ui-sans-serif,system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";--code-font:"IBMPlexMono",ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;--homepage-max-width:750px;--main-max-width:750px;--avatar-size:175px;--paragraph-font-size:16px;--paragraph-line-height:1.5em;--aside-font-size:16px;--img-border-radius:4px;--inline-code-border-radius:2px}body.dark{--primary-color:#689afd;--primary-pale-color:#93acdd1c;--inline-code-color:#d2d2d2;--text-color:#ddd;--text-pale-color:#a0a0a0;--bg-color:#202124;--highlight-mark-color:#5f75b045;--callout-note-color:#698bcf;--callout-important-color:#9374c5;--callout-warning-color:#c99054;--callout-alert-color:#d35757;--callout-question-color:#5091b2;--callout-tip-color:#3ea06f}</style><link href=/main.css rel=stylesheet><body class=post><script>if(localStorage.getItem('theme')=='dark'){document.body.classList.add('dark');const a=document.querySelector('link#hl');if(a)a.href='/hl-dark.css'}</script><header class=blur><div id=header-wrapper><nav><a href=/>The Oops guy</a><button aria-label="toggle expand" class=separator id=toggler>::</button><span class="wrap left fold">{</span><a href=/blog>blog</a><span class="wrap-separator fold">,</span><a class=fold href=/projects>projects</a><span class="wrap right fold">} ;</span></nav><div id=btns><a aria-label="rss feed" href=/blog/atom.xml><svg viewbox="0 0 24 24" height=24 width=24 xmlns=http://www.w3.org/2000/svg><path d="M3 17C5.20914 17 7 18.7909 7 21H3V17ZM3 10C9.07513 10 14 14.9249 14 21H12C12 16.0294 7.97056 12 3 12V10ZM3 3C12.9411 3 21 11.0589 21 21H19C19 12.1634 11.8366 5 3 5V3Z" fill=currentColor></path></svg></a><a rel="noreferrer noopener" aria-label=GitHub href=https://github.com/Pawan-666 target=_blank> <svg viewbox="0 0 24 24" xmlns=http://www.w3.org/2000/svg><title>GitHub</title><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12" fill=currentColor></path></svg> </a><a rel="noreferrer noopener" aria-label=Twitter href=https://twitter.com/PawanCh09197754 target=_blank> <svg viewbox="0 0 24 24" xmlns=http://www.w3.org/2000/svg><title>Twitter</title><path d="M23.953 4.57a10 10 0 01-2.825.775 4.958 4.958 0 002.163-2.723c-.951.555-2.005.959-3.127 1.184a4.92 4.92 0 00-8.384 4.482C7.69 8.095 4.067 6.13 1.64 3.162a4.822 4.822 0 00-.666 2.475c0 1.71.87 3.213 2.188 4.096a4.904 4.904 0 01-2.228-.616v.06a4.923 4.923 0 003.946 4.827 4.996 4.996 0 01-2.212.085 4.936 4.936 0 004.604 3.417 9.867 9.867 0 01-6.102 2.105c-.39 0-.779-.023-1.17-.067a13.995 13.995 0 007.557 2.209c9.053 0 13.998-7.496 13.998-13.985 0-.21 0-.42-.015-.63A9.935 9.935 0 0024 4.59z" fill=currentColor></path></svg> </a><a rel="noreferrer noopener" aria-label=LinkedIn href=https://www.linkedin.com/in/pawan-chhetri-a91821169/ target=_blank> <svg viewbox="0 0 24 24" xmlns=http://www.w3.org/2000/svg><title>LinkedIn</title><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z" fill=currentColor></path></svg> </a><button aria-label="theme switch" data-moon-icon='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"><path d="M10 7C10 10.866 13.134 14 17 14C18.9584 14 20.729 13.1957 21.9995 11.8995C22 11.933 22 11.9665 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12C2 6.47715 6.47715 2 12 2C12.0335 2 12.067 2 12.1005 2.00049C10.8043 3.27098 10 5.04157 10 7ZM4 12C4 16.4183 7.58172 20 12 20C15.0583 20 17.7158 18.2839 19.062 15.7621C18.3945 15.9187 17.7035 16 17 16C12.0294 16 8 11.9706 8 7C8 6.29648 8.08133 5.60547 8.2379 4.938C5.71611 6.28423 4 8.9417 4 12Z" fill="currentColor"></path></svg>' data-sun-icon='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"><path d="M12 18C8.68629 18 6 15.3137 6 12C6 8.68629 8.68629 6 12 6C15.3137 6 18 8.68629 18 12C18 15.3137 15.3137 18 12 18ZM12 16C14.2091 16 16 14.2091 16 12C16 9.79086 14.2091 8 12 8C9.79086 8 8 9.79086 8 12C8 14.2091 9.79086 16 12 16ZM11 1H13V4H11V1ZM11 20H13V23H11V20ZM3.51472 4.92893L4.92893 3.51472L7.05025 5.63604L5.63604 7.05025L3.51472 4.92893ZM16.9497 18.364L18.364 16.9497L20.4853 19.0711L19.0711 20.4853L16.9497 18.364ZM19.0711 3.51472L20.4853 4.92893L18.364 7.05025L16.9497 5.63604L19.0711 3.51472ZM5.63604 16.9497L7.05025 18.364L4.92893 20.4853L3.51472 19.0711L5.63604 16.9497ZM23 11V13H20V11H23ZM4 11V13H1V11H4Z" fill="currentColor"></path></svg>' id=theme-toggle><svg viewbox="0 0 24 24" height=24 width=24 xmlns=http://www.w3.org/2000/svg><path d="M10 7C10 10.866 13.134 14 17 14C18.9584 14 20.729 13.1957 21.9995 11.8995C22 11.933 22 11.9665 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12C2 6.47715 6.47715 2 12 2C12.0335 2 12.067 2 12.1005 2.00049C10.8043 3.27098 10 5.04157 10 7ZM4 12C4 16.4183 7.58172 20 12 20C15.0583 20 17.7158 18.2839 19.062 15.7621C18.3945 15.9187 17.7035 16 17 16C12.0294 16 8 11.9706 8 7C8 6.29648 8.08133 5.60547 8.2379 4.938C5.71611 6.28423 4 8.9417 4 12Z" fill=currentColor></path></svg></button><button aria-label="table of content" id=toc-toggle><svg viewbox="0 0 24 24" height=24 width=24 xmlns=http://www.w3.org/2000/svg><path d="M3 4H21V6H3V4ZM3 11H15V13H3V11ZM3 18H21V20H3V18Z" fill=currentColor></path></svg></button></div></div></header><div id=wrapper><div id=blank></div><aside class=blur><nav><ul><li><a class=h2 href=#why-choose-kubernetes-over-docker-compose>Why choose Kubernetes over docker-compose?</a><li><a class=h2 href=#setup-requirements>Setup requirements</a> <ul><li><a class=h3 href=#a-linux-server-desktop>A Linux Server/Desktop</a><li><a class=h3 href=#k3s-lightweight-kubernetes-easy-to-install-half-the-memory-all-in-a-binary-of-less-than-100-mb>k3s Lightweight Kubernetes. Easy to install, half the memory, all in a binary of less than 100 MB</a><li><a class=h3 href=#a-domain-name>A domain name</a><li><a class=h3 href=#setting-cloudflare-tunnel>Setting cloudflare tunnel</a></ul><li><a class=h2 href=#kubernetes-deployment>Kubernetes deployment</a> <ul><li><a class=h3 href=#k8s-manifest>k8s manifest</a><li><a class=h3 href=#k-apply-f-jellyfin-yml>❯ k apply -f jellyfin.yml</a><li><a class=h3 href=#grafana-prometheus-helm>grafana-prometheus helm</a></ul></ul></nav><button aria-label="back to top" id=back-to-top><svg viewbox="0 0 24 24" height=24 width=24 xmlns=http://www.w3.org/2000/svg><path d="M11.9997 10.8284L7.04996 15.7782L5.63574 14.364L11.9997 8L18.3637 14.364L16.9495 15.7782L11.9997 10.8284Z" fill=currentColor></path></svg></button></aside><main><div><div data-check-icon='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"><path d="M10.0007 15.1709L19.1931 5.97852L20.6073 7.39273L10.0007 17.9993L3.63672 11.6354L5.05093 10.2212L10.0007 15.1709Z" fill="currentColor"></path></svg>' data-copy-icon='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"><path d="M6.9998 6V3C6.9998 2.44772 7.44752 2 7.9998 2H19.9998C20.5521 2 20.9998 2.44772 20.9998 3V17C20.9998 17.5523 20.5521 18 19.9998 18H16.9998V20.9991C16.9998 21.5519 16.5499 22 15.993 22H4.00666C3.45059 22 3 21.5554 3 20.9991L3.0026 7.00087C3.0027 6.44811 3.45264 6 4.00942 6H6.9998ZM5.00242 8L5.00019 20H14.9998V8H5.00242ZM8.9998 6H16.9998V16H18.9998V4H8.9998V6Z" fill="currentColor"></path></svg>' id=copy-cfg style=display:none></div><article data-backlink-icon='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="20" height="20"><path d="M9.41421 8L18.0208 16.6066L16.6066 18.0208L8 9.41421V17H6V6H17V8H9.41421Z" fill="currentColor"></path></svg>' class=prose><h1>Kubernetes Homelab</h1><div id=post-info><div id=date><span id=publish>2024-06-20</span></div><div id=tags><a href=https://pawanchhetri.com.np/tags/k8s><span>#</span>k8s</a><a href=https://pawanchhetri.com.np/tags/docker-compose><span>#</span>docker-compose</a><a href=https://pawanchhetri.com.np/tags/homelab><span>#</span>homelab</a><a href=https://pawanchhetri.com.np/tags/self-hosted><span>#</span>self-hosted</a><a href=https://pawanchhetri.com.np/tags/linux><span>#</span>linux</a></div></div><p>   I’ve been using my old laptop as a home server for about a year. Initially, I relied on Docker Compose to manage different services, which works well for single or multiple users. For a single or multiple users docker-compose is definitely the best way to set up a homelab server. But I wanted to use Kubernetes because Kubernetes is the optimal solution, especially if I want several users at once and setting Kubernetes is fun. So, I’m upgrading to Kubernetes to deploy a media server and deploy a monitoring solution too. I’m also exposing these services through domain name, making them accessible from anywhere on the internet.<p><img alt src=/images/2024-07-09-18-19-18.png><h3 id=why-choose-kubernetes-over-docker-compose>Why choose Kubernetes over docker-compose?<a aria-label="Anchor link for: why-choose-kubernetes-over-docker-compose" class=zola-anchor href=#why-choose-kubernetes-over-docker-compose>#</a></h3><ol><li><p>Automatic Scaling: Kubernetes can scale up or down based on the demand. When more users access the service, Kubernetes will roll out additional pods (instances) as needed and scale back down when the demand decreases.</p><li><p>High Reliability: Kubernetes ReplicaSets ensure that a specified number of pod replicas are running at any given time, thus maintaining the desired level of redundancy. With multiple replicas/instances running, user traffic is efficiently distributed, ensuring smooth performance.</p><li><p>Self-Healing : Kubernetes can automatically detect and replace failing containers, rescheduling them as needed to ensure minimal disruption to your services.</p><li><p>Extensive Ecosystem : Kubernetes offers a vast range of plugins and tools, making it easy to integrate with other technologies and services, enhancing the functionality and efficiency of your homelab server.</p></ol><p>This makes Kubernetes not just a powerful tool but an essential upgrade for anyone looking to manage a homelab server effectively, especially with multiple users in mind.<p><code>Having a system with decent specs is recommended otherwise its a lost cause tho</code><h3 id=setup-requirements>Setup requirements<a aria-label="Anchor link for: setup-requirements" class=zola-anchor href=#setup-requirements>#</a></h3><h4 id=a-linux-server-desktop>A Linux Server/Desktop<a aria-label="Anchor link for: a-linux-server-desktop" class=zola-anchor href=#a-linux-server-desktop>#</a></h4><p>My system specs are 4C CPU, 6GB RAM ,1TB Disk. This is not the recommended specs to run media server but workable enough to certain extent.<h4 id=k3s-lightweight-kubernetes-easy-to-install-half-the-memory-all-in-a-binary-of-less-than-100-mb><a rel="nofollow noreferrer" href=https://docs.k3s.io/>k3s</a> <code>Lightweight Kubernetes. Easy to install, half the memory, all in a binary of less than 100 MB</code><a aria-label="Anchor link for: k3s-lightweight-kubernetes-easy-to-install-half-the-memory-all-in-a-binary-of-less-than-100-mb" class=zola-anchor href=#k3s-lightweight-kubernetes-easy-to-install-half-the-memory-all-in-a-binary-of-less-than-100-mb>#</a></h4><p>I’m installing k3s on my machine, which is Lightweight kubernetes. It works on the basis that your machine is master node and worker node at once but other worker nodes can be added easily.<pre style=background:#2e3440;color:#d8dee9><code><span>curl -sfL https://get.k3s.io | sh -       # Installation command 
</span></code></pre><p><img alt src=/images/2024-06-20-21-02-18.png> K3s runs as a daemon on the server. The dotted ip will be used later to map domain names in Cloudflare tunnels.<p>Best practices:<ul><li>initial kube config is present in /etc/rancher/k3s/k3s.yaml</ul><p>you can set this as default config too<pre style=background:#2e3440;color:#d8dee9><code><span>mkdir ~/.kube
</span><span>cp /etc/rancher/k3s/k3s.yaml ~/.kube/config
</span><span>chmod 600 ~/.kube/config
</span></code></pre><ul><li>Put these commands in shell config file for persistence</ul><pre style=background:#2e3440;color:#d8dee9><code><span>alias k='sudo k3s kubectl'
</span><span>alias kubectl='sudo k3s kubectl'
</span><span>export KUBECONFIG=/home/pawan/.kube/config
</span></code></pre><h4 id=a-domain-name><a rel="nofollow noreferrer" href=https://pawanchhetri.com.np>A domain name</a><a aria-label="Anchor link for: a-domain-name" class=zola-anchor href=#a-domain-name>#</a></h4><p>Either buy a cheap one or apply for a free one. Set cloudflare nameservers.<h4 id=setting-cloudflare-tunnel><a rel="nofollow noreferrer" href=https://developers.cloudflare.com/cloudflare-one/connections/connect-networks/get-started/>Setting cloudflare tunnel</a><a aria-label="Anchor link for: setting-cloudflare-tunnel" class=zola-anchor href=#setting-cloudflare-tunnel>#</a></h4><p>This allows us to map socket(exposed port of our local machine/ip) with a domain name.<p>There are multiple ways to set this up.<p>I’ve installed cloudflared using docker agent. <img alt src=/images/2024-06-20-20-16-36.png><p><img alt src=/images/2024-06-20-19-21-24.png> The tunnel status should be <code>HEALTHY</code>.<p>I’ll be deploying services for these two domains.<ul><li><a rel="nofollow noreferrer" href=https://jellyfin.pawanchhetri.com.np>jellyfin.pawanchhetri.com.np</a><li><a rel="nofollow noreferrer" href=https://grafana.pawanchhetri.com.np>grafana.pawanchhetri.com.np</a></ul><p><img alt src=/images/2024-06-20-19-20-15.png><h3 id=kubernetes-deployment>Kubernetes deployment<a aria-label="Anchor link for: kubernetes-deployment" class=zola-anchor href=#kubernetes-deployment>#</a></h3><p>I’m setting up <a rel="nofollow noreferrer" href=https://jellyfin.org/>jellyfin</a> (The Free Software Media System) to host my downloaded movies, tv_shows, music, books, audioBooks, podcasts, images.<h4 id=k8s-manifest>k8s manifest<a aria-label="Anchor link for: k8s-manifest" class=zola-anchor href=#k8s-manifest>#</a></h4><p>Using a single manifest file for namespace, deployment, hpa, service for ease of deployment.<p>❯ cat jellyfin.yml<pre class=language-yaml data-lang=yaml style=background:#2e3440;color:#d8dee9><code class=language-yaml data-lang=yaml><span style=color:#616e88>#Creating a jellyfin namespace 
</span><span>
</span><span style=color:#8fbcbb>apiVersion</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>v1
</span><span style=color:#8fbcbb>kind</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>Namespace
</span><span style=color:#8fbcbb>metadata</span><span style=color:#eceff4>:
</span><span>  </span><span style=color:#8fbcbb>name</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>jellyfin
</span><span>
</span><span>---
</span><span>
</span><span style=color:#616e88>#Creating a Deployment with resource allocation
</span><span>
</span><span style=color:#8fbcbb>apiVersion</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>apps/v1
</span><span style=color:#8fbcbb>kind</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>Deployment
</span><span style=color:#8fbcbb>metadata</span><span style=color:#eceff4>:
</span><span>  </span><span style=color:#8fbcbb>name</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>jellyfin
</span><span>  </span><span style=color:#8fbcbb>namespace</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>jellyfin
</span><span>  </span><span style=color:#8fbcbb>labels</span><span style=color:#eceff4>:
</span><span>    </span><span style=color:#8fbcbb>app</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>jellyfin
</span><span style=color:#8fbcbb>spec</span><span style=color:#eceff4>:
</span><span>  </span><span style=color:#8fbcbb>replicas</span><span style=color:#eceff4>: </span><span style=color:#b48ead>1      </span><span style=color:#616e88># I'm the only user using it
</span><span>  </span><span style=color:#8fbcbb>selector</span><span style=color:#eceff4>:
</span><span>    </span><span style=color:#8fbcbb>matchLabels</span><span style=color:#eceff4>:
</span><span>      </span><span style=color:#8fbcbb>app</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>jellyfin
</span><span>  </span><span style=color:#8fbcbb>template</span><span style=color:#eceff4>:
</span><span>    </span><span style=color:#8fbcbb>metadata</span><span style=color:#eceff4>:
</span><span>      </span><span style=color:#8fbcbb>labels</span><span style=color:#eceff4>:
</span><span>        </span><span style=color:#8fbcbb>app</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>jellyfin
</span><span>    </span><span style=color:#8fbcbb>spec</span><span style=color:#eceff4>:
</span><span>      </span><span style=color:#8fbcbb>containers</span><span style=color:#eceff4>:
</span><span>      - </span><span style=color:#8fbcbb>name</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>jellyfin
</span><span>        </span><span style=color:#8fbcbb>image</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>jellyfin/jellyfin
</span><span>        </span><span style=color:#8fbcbb>ports</span><span style=color:#eceff4>:
</span><span>        - </span><span style=color:#8fbcbb>containerPort</span><span style=color:#eceff4>: </span><span style=color:#b48ead>8096
</span><span>        </span><span style=color:#8fbcbb>resources</span><span style=color:#eceff4>:
</span><span>          </span><span style=color:#8fbcbb>requests</span><span style=color:#eceff4>:
</span><span>            </span><span style=color:#8fbcbb>memory</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>"512Mi"  </span><span style=color:#616e88># Requesting 512Mi of RAM
</span><span>            </span><span style=color:#8fbcbb>cpu</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>"500m"      </span><span style=color:#616e88># Requesting 0.5 CPU core
</span><span>          </span><span style=color:#8fbcbb>limits</span><span style=color:#eceff4>:
</span><span>            </span><span style=color:#8fbcbb>memory</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>"1Gi"    </span><span style=color:#616e88># Limiting to 1Gi of RAM
</span><span>            </span><span style=color:#8fbcbb>cpu</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>"1000m"     </span><span style=color:#616e88># Limiting to 1 CPU cores
</span><span>        </span><span style=color:#8fbcbb>volumeMounts</span><span style=color:#eceff4>:
</span><span>        - </span><span style=color:#8fbcbb>name</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>config-volume
</span><span>          </span><span style=color:#8fbcbb>mountPath</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>/config
</span><span>        - </span><span style=color:#8fbcbb>name</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>cache-volume
</span><span>          </span><span style=color:#8fbcbb>mountPath</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>/cache
</span><span>        - </span><span style=color:#8fbcbb>name</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>media1
</span><span>          </span><span style=color:#8fbcbb>mountPath</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>/media1
</span><span>        - </span><span style=color:#8fbcbb>name</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>media2
</span><span>          </span><span style=color:#8fbcbb>mountPath</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>/media2
</span><span>        - </span><span style=color:#8fbcbb>name</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>media3
</span><span>          </span><span style=color:#8fbcbb>mountPath</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>/media3
</span><span>        - </span><span style=color:#8fbcbb>name</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>media4
</span><span>          </span><span style=color:#8fbcbb>mountPath</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>/media4
</span><span>        - </span><span style=color:#8fbcbb>name</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>media5
</span><span>          </span><span style=color:#8fbcbb>mountPath</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>/media5
</span><span>        - </span><span style=color:#8fbcbb>name</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>media6
</span><span>          </span><span style=color:#8fbcbb>mountPath</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>/media6
</span><span>      </span><span style=color:#8fbcbb>volumes</span><span style=color:#eceff4>:
</span><span>      - </span><span style=color:#8fbcbb>name</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>config-volume
</span><span>        </span><span style=color:#8fbcbb>hostPath</span><span style=color:#eceff4>:
</span><span>          </span><span style=color:#8fbcbb>path</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>/home/pawan/k8s_homelab/jellyfin/scratch/config
</span><span>      - </span><span style=color:#8fbcbb>name</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>cache-volume
</span><span>        </span><span style=color:#8fbcbb>hostPath</span><span style=color:#eceff4>:
</span><span>          </span><span style=color:#8fbcbb>path</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>/home/pawan/k8s_homelab/jellyfin/scratch/cache
</span><span>      - </span><span style=color:#8fbcbb>name</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>media1
</span><span>        </span><span style=color:#8fbcbb>hostPath</span><span style=color:#eceff4>:
</span><span>          </span><span style=color:#8fbcbb>path</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>/home/pawan/Storage/Movies/
</span><span>      - </span><span style=color:#8fbcbb>name</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>media2
</span><span>        </span><span style=color:#8fbcbb>hostPath</span><span style=color:#eceff4>:
</span><span>          </span><span style=color:#8fbcbb>path</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>/home/pawan/Storage/tv_shows/
</span><span>      - </span><span style=color:#8fbcbb>name</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>media3
</span><span>        </span><span style=color:#8fbcbb>hostPath</span><span style=color:#eceff4>:
</span><span>          </span><span style=color:#8fbcbb>path</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>/home/pawan/Storage/Books/
</span><span>      - </span><span style=color:#8fbcbb>name</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>media4
</span><span>        </span><span style=color:#8fbcbb>hostPath</span><span style=color:#eceff4>:
</span><span>          </span><span style=color:#8fbcbb>path</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>/home/pawan/Storage/music/
</span><span>      - </span><span style=color:#8fbcbb>name</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>media5
</span><span>        </span><span style=color:#8fbcbb>hostPath</span><span style=color:#eceff4>:
</span><span>          </span><span style=color:#8fbcbb>path</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>/home/pawan/Storage/AudioBooks/
</span><span>      - </span><span style=color:#8fbcbb>name</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>media6
</span><span>        </span><span style=color:#8fbcbb>hostPath</span><span style=color:#eceff4>:
</span><span>          </span><span style=color:#8fbcbb>path</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>/home/pawan/Storage/podcast/
</span><span>
</span><span>
</span><span>---
</span><span style=color:#616e88># autoscaling pods when load increases/decreases
</span><span style=color:#616e88># omit this part if you are a single user and don't have much resource on your system
</span><span>
</span><span style=color:#8fbcbb>apiVersion</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>autoscaling/v2
</span><span style=color:#8fbcbb>kind</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>HorizontalPodAutoscaler
</span><span style=color:#8fbcbb>metadata</span><span style=color:#eceff4>:
</span><span>  </span><span style=color:#8fbcbb>name</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>jellyfin-hpa
</span><span>  </span><span style=color:#8fbcbb>namespace</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>jellyfin
</span><span style=color:#8fbcbb>spec</span><span style=color:#eceff4>:
</span><span>  </span><span style=color:#8fbcbb>scaleTargetRef</span><span style=color:#eceff4>:
</span><span>    </span><span style=color:#8fbcbb>apiVersion</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>apps/v1
</span><span>    </span><span style=color:#8fbcbb>kind</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>Deployment
</span><span>    </span><span style=color:#8fbcbb>name</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>jellyfin
</span><span>  </span><span style=color:#8fbcbb>minReplicas</span><span style=color:#eceff4>: </span><span style=color:#b48ead>1
</span><span>  </span><span style=color:#8fbcbb>maxReplicas</span><span style=color:#eceff4>: </span><span style=color:#b48ead>3
</span><span>  </span><span style=color:#8fbcbb>metrics</span><span style=color:#eceff4>:
</span><span>  - </span><span style=color:#8fbcbb>type</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>Resource
</span><span>    </span><span style=color:#8fbcbb>resource</span><span style=color:#eceff4>:
</span><span>      </span><span style=color:#8fbcbb>name</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>cpu
</span><span>      </span><span style=color:#8fbcbb>target</span><span style=color:#eceff4>:
</span><span>        </span><span style=color:#8fbcbb>type</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>Utilization
</span><span>        </span><span style=color:#8fbcbb>averageUtilization</span><span style=color:#eceff4>: </span><span style=color:#b48ead>50  </span><span style=color:#616e88># Target average CPU utilization percentage
</span><span>
</span><span>---
</span><span style=color:#616e88># Exposing jellyfin through my local_ip:30096
</span><span>
</span><span style=color:#8fbcbb>apiVersion</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>v1
</span><span style=color:#8fbcbb>kind</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>Service
</span><span style=color:#8fbcbb>metadata</span><span style=color:#eceff4>:
</span><span>  </span><span style=color:#8fbcbb>name</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>jellyfin
</span><span>  </span><span style=color:#8fbcbb>namespace</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>jellyfin
</span><span>  </span><span style=color:#8fbcbb>labels</span><span style=color:#eceff4>:
</span><span>    </span><span style=color:#8fbcbb>app</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>jellyfin
</span><span style=color:#8fbcbb>spec</span><span style=color:#eceff4>:
</span><span>  </span><span style=color:#8fbcbb>type</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>NodePort
</span><span>  </span><span style=color:#8fbcbb>ports</span><span style=color:#eceff4>:
</span><span>  - </span><span style=color:#8fbcbb>port</span><span style=color:#eceff4>: </span><span style=color:#b48ead>8096
</span><span>    </span><span style=color:#8fbcbb>targetPort</span><span style=color:#eceff4>: </span><span style=color:#b48ead>8096
</span><span>    </span><span style=color:#8fbcbb>nodePort</span><span style=color:#eceff4>: </span><span style=color:#b48ead>30096  </span><span style=color:#616e88># This is optional; Kubernetes will automatically assign a port if you omit this line
</span><span>    </span><span style=color:#8fbcbb>protocol</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>TCP
</span><span>  </span><span style=color:#8fbcbb>selector</span><span style=color:#eceff4>:
</span><span>    </span><span style=color:#8fbcbb>app</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>jellyfin
</span></code></pre><h4 id=k-apply-f-jellyfin-yml>❯ k apply -f jellyfin.yml<a aria-label="Anchor link for: k-apply-f-jellyfin-yml" class=zola-anchor href=#k-apply-f-jellyfin-yml>#</a></h4><p><img alt src=/images/2024-06-21-12-35-43.png><p>Since we have mapped the ip:port to the domain, hitting the domain name will open up the jellyfin signup/login page. GUI configuration is straightforward.<p><img alt src=/images/2024-06-20-20-33-40.png>                                 jellyfin UI<h4 id=grafana-prometheus-helm><a rel="nofollow noreferrer" href=https://artifacthub.io/packages/helm/prometheus-community/kube-prometheus-stack>grafana-prometheus helm</a><a aria-label="Anchor link for: grafana-prometheus-helm" class=zola-anchor href=#grafana-prometheus-helm>#</a></h4><p>Grafana-prometheus is still the most lightweight monitoring solution using kubernetes to monitor k8s resources.<p>I’m using <a rel="nofollow noreferrer" href=https://helm.sh/docs/intro/install/>helm</a> to deploy this stack since it is the most straightforward way to install grafana-prometheus on kubernetes. I’m deploying this on default namespace.<pre class=language-bash data-lang=bash style=background:#2e3440;color:#d8dee9><code class=language-bash data-lang=bash><span style=color:#88c0d0>helm</span><span> repo add prometheus-community https://prometheus-community.github.io/helm-charts
</span><span style=color:#88c0d0>helm</span><span> repo update
</span><span>
</span><span style=color:#616e88># helm install [RELEASE_NAME] prometheus-community/kube-prometheus-stack
</span><span style=color:#88c0d0>helm</span><span> install my-promethues-grafana  prometheus-community/kube-prometheus-stack
</span><span>
</span><span style=color:#616e88># helm upgrade [RELEASE_NAME] prometheus-community/kube-prometheus-stack
</span><span>
</span><span style=color:#616e88>#changing default values if needed
</span><span style=color:#88c0d0>helm</span><span> show values prometheus-community/kube-prometheus-stack </span><span style=color:#81a1c1>></span><span> values.yaml
</span><span style=color:#88c0d0>helm</span><span> upgrade my-promethues-grafana prometheus-community/kube-prometheus-stack -f values.yaml  
</span><span>
</span><span>
</span><span style=color:#616e88># helm uninstall [RELEASE_NAME]
</span></code></pre><p>Change the grafana svc to NodePort to access it from outside and also to map to domain name. Setting NodePort svc for prometheus is optional since all the targets are up by default and the integration as data sources is also done automatically. <img alt src=/images/2024-06-20-20-12-14.png><p>A lot of dashboards are loaded by default which might be enough for k8s monitoring. But we can create dashboards manually or grab an Id from <a rel="nofollow noreferrer" href=https://grafana.com/grafana/dashboards/>grafana_dashboards</a> of your choice and import it.<p><img alt src=/images/2024-06-20-19-31-50.png> Host monitoring - Node Exporter Full(ID 1860)<p><img alt src=/images/2024-06-21-13-06-25.png> K8s resource monitoring - kube-state-metrics-v2(ID 13332)<p>So any service that can be deployed with docker/docker-compose can be converted into kubernetes either by deploying manifest files or helm charts. How much complexity you want is your choice!</article><div class=giscus></div><script async crossorigin data-category=General data-category-id=DIC_kwDOL6heGM4CfTnr data-emit-metadata=0 data-input-position=bottom data-lang=en data-loading=lazy data-mapping=pathname data-reactions-enabled=1 data-repo=Pawan-666/website_new_theme data-repo-id=R_kgDOL6heGA data-strict=0 data-theme=preferred_color_scheme src=https://giscus.app/client.js></script></div><footer><div class=copyright><p>© 2024 Pawan Chhetri</div><div class=credits>Powered by <a rel="noreferrer noopener" href=https://www.getzola.org target=_blank>zola</a> and <a rel="noreferrer noopener" href=https://github.com/isunjn/serene target=_blank>serene</a></div></footer></main></div><script src=/js/lightense.min.js></script><script src=/js/main.js></script>